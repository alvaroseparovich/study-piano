<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MIDI Keyboard - QWERTY -> Notes</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;background:#0f172a;color:#e6eef8}
    .card{background:#0b1220;padding:16px;border-radius:12px;max-width:820px}
    label,select,button{font-size:14px}
    .row{display:flex;gap:12px;align-items:center;margin:8px 0}
    .kbd{display:inline-block;padding:6px 10px;border-radius:6px;background:#0b1220;border:1px solid #223;min-width:26px;text-align:center}
    .help{opacity:.8;font-size:13px;margin-top:8px}
    .key{
      flex-direction: column;
      justify-content: space-between;
    }
    .key.white{ color:black}
    .scaleOff {opacity: 40%}
  </style>
  <link rel="stylesheet" href="style.css"></style>
</head>
<body>
  <div class="card">
    <h6 style="margin: 0;">MIDI keyboard (Q..P + numbers) — WebMIDI + fallback synth</h6>
    <div class="row">
      <button id="enableMidi">Enable MIDI</button>
      <label for="outputs">MIDI Output:</label>
      <select id="outputs"><option value="none">(no output selected)</option></select>
      <label for="channel">Ch</label>
      <input id="channel" type="number" min="1" max="16" value="1" style="width:56px" />
    </div>
    <div class="row">
      <label><input type="checkbox" id="useSynth" checked/> Use built-in synth if no MIDI</label>
      <label style="margin-left:12px">Volume</label>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6" />
    </div>

    <div class="help">Keys mapping: Q W E R T Y U I O P  Numbers 2 3 5 6 7 9 0... Hold a key to sustain; release to stop.</div>
<script>
  
const KEYNAME_NOTE = {
  'KeyQ': 60, // C4
  'Digit2': 61, // C#4
  'KeyW': 62, // D4
  'Digit3': 63, // D#4
  'KeyE': 64, // E4
  'KeyR': 65, // F4
  'Digit5': 66, // F#4
  'KeyT': 67, // G4
  'Digit6': 68, // G#4
  'KeyY': 69, // A4
  'Digit7': 70, // A#4
  'KeyU': 71, // B4
  'KeyI': 72, // C5
  'Digit9': 73, // C#5
  'KeyO': 74, // D5
  'Digit0': 75, // D#5
  'KeyP': 76,  // E5
  // --------------
  // Second Hand
  'IntlBackslash': 77, // F5
  'KeyA': 78, // F#5
  'KeyZ': 79, // G5
  'KeyS': 80, // G#5
  'KeyX': 81, // A5
  'KeyD': 82, // A#5
  'KeyC': 83, // B5
  'KeyV': 84, // C6
  'KeyG': 85, // C#6
  'KeyB': 86, // D6
  'KeyH': 87, // D#6
  'KeyN': 88, // E6
  'KeyM': 89, // F6
  'KeyK': 90, // F#6
  'Comma': 91, // G6
  'KeyL': 92, // G#6
  'Period': 93, // A6
  'Semicolon': 94, // A#6
  'Slash': 95, // B6
};

let midiAccess = null;
let midiOutputs = new Map();
let selectedOutputId = null;
const outputsSelect = document.getElementById('outputs');
const enableBtn = document.getElementById('enableMidi');
const channelInput = document.getElementById('channel');
const useSynthCheckbox = document.getElementById('useSynth');
const volumeControl = document.getElementById('volume');

// WebAudio fallback synth
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const activeOsc = new Map();
const synthGain = audioCtx.createGain();
synthGain.gain.value = parseFloat(volumeControl.value);
synthGain.connect(audioCtx.destination);
volumeControl.addEventListener('input', ()=> synthGain.gain.value = parseFloat(volumeControl.value));

function midiNoteToFreq(note, octaveShift = 1) {
  return 440 * Math.pow(2, ((note - 12 * octaveShift) - 69) / 12);
}

function startSynth(note){
  if (activeOsc.has(note)) return;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = 'sawtooth';
  osc.frequency.value = midiNoteToFreq(note);
  g.gain.setValueAtTime(0, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(0.7, audioCtx.currentTime + 0.01);
  g.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.2);
  osc.connect(g); g.connect(synthGain);
  osc.start();
  activeOsc.set(note, {osc,g});
}

function stopSynth(note){
  const node = activeOsc.get(note);
  if (!node) return;
  const {osc,g} = node;
  g.gain.cancelScheduledValues(audioCtx.currentTime);
  g.gain.setValueAtTime(g.gain.value, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2);
  setTimeout(()=>{
    try{ osc.stop(); }catch(e){}
    osc.disconnect(); g.disconnect();
  }, 300);
  activeOsc.delete(note);
}

function noteOnMIDI(note, velocity=0x7f){
  if (!midiAccess || !selectedOutputId) return;
  const out = midiOutputs.get(selectedOutputId);
  if (!out) return;
  const channel = Math.max(1, Math.min(16, parseInt(channelInput.value || '1')))-1;
  const status = 0x90 | channel;
  out.send([status, note & 0x7f, velocity & 0x7f]);
}
function noteOffMIDI(note){
  if (!midiAccess || !selectedOutputId) return;
  const out = midiOutputs.get(selectedOutputId);
  if (!out) return;
  const channel = Math.max(1, Math.min(16, parseInt(channelInput.value || '1')))-1;
  const status = 0x80 | channel;
  out.send([status, note & 0x7f, 0x40]);
}

async function enableMIDI(){
  try{
    midiAccess = await navigator.requestMIDIAccess();
    midiAccess.onstatechange = refreshOutputs;
    refreshOutputs();
    enableBtn.textContent = 'MIDI enabled';
    enableBtn.disabled = true;
  }catch(err){
    console.warn('MIDI access failed', err);
    enableBtn.textContent = 'MIDI unavailable';
    enableBtn.disabled = true;
  }
}

function refreshOutputs(){
  midiOutputs.clear();
  outputsSelect.innerHTML = '';
  const noneOpt = document.createElement('option'); noneOpt.value='none'; noneOpt.textContent='(no output selected)';
  outputsSelect.appendChild(noneOpt);
  if (!midiAccess) return;
  for (const output of midiAccess.outputs.values()){
    midiOutputs.set(output.id, output);
    const opt = document.createElement('option');
    opt.value = output.id;
    opt.textContent = `${output.name} — ${output.manufacturer}`;
    outputsSelect.appendChild(opt);
  }
}

outputsSelect.addEventListener('change', ()=>{
  selectedOutputId = outputsSelect.value === 'none' ? null : outputsSelect.value;
});

enableBtn.addEventListener('click', async ()=>{
  await enableMIDI();
});

// keyboard handling: track pressed keys to avoid repeats
const pressed = new Set();
// Modify keydown and keyup to add/remove visual feedback
window.addEventListener('keydown', (ev)=>{
  console.log(ev.key, ev);
  const k = ev.code;
  if (!KEYNAME_NOTE.hasOwnProperty(k)) return;
  if (pressed.has(k)) return; // held
  pressed.add(k);
  const note = KEYNAME_NOTE[k];
    // ensure audio context resumed
  if (audioCtx.state === 'suspended') audioCtx.resume();
  if (midiAccess && selectedOutputId){
  noteOnMIDI(note, 0x7f);
  }else if (useSynthCheckbox.checked){
  startSynth(note);
  }
  document.querySelector(`.${k}`)?.classList.add('key-down');
  ev.preventDefault();
});

window.addEventListener('keyup', (ev)=>{
  const k = ev.code;
  if (!KEYNAME_NOTE.hasOwnProperty(k)) return;
  pressed.delete(k);
  const note = KEYNAME_NOTE[k];
  if (midiAccess && selectedOutputId){
  noteOffMIDI(note);
  }else if (useSynthCheckbox.checked){
  stopSynth(note);
  }
  document.querySelector(`.${k}`)?.classList.remove('key-down');
  ev.preventDefault();
});

// also handle visibility change: stop all on blur
window.addEventListener('blur', ()=>{
  for (const k of Array.from(pressed)){
    const note = KEYNAME_NOTE[k];
    if (midiAccess && selectedOutputId) noteOffMIDI(note);
    else if (useSynthCheckbox.checked) stopSynth(note);
  }
  pressed.clear();
});

// Helpful: allow clicking on onscreen keys to test
// (simple implementation)
</script>




<div class="octave-midle keyboard-scales" style="display:flex"> 

  <div class="keyboard k-4"> 
    <div class="key white C KeyQ midi-60" data-midi="60"><span class="grau"> </span><span>C</span></div> 
    <div class="key black Cs Df Digit2 midi-61" data-midi="61"><span class="grau"> </span><span>C#</span></div>
    <div class="key white D KeyW midi-62" data-midi="62"><span class="grau"> </span><span>D</span></div>
    <div class="key black Ds Ef Digit3 midi-63" data-midi="63"><span class="grau"> </span><span>D#</span></div>
    <div class="key white E  KeyE midi-64" data-midi="64"><span class="grau"> </span><span>E</span></div>
    <div class="key white F KeyR midi-65" data-midi="65"><span class="grau"> </span><span>F</span></div>
    <div class="key black Fs Gf Digit5 midi-66" data-midi="66"><span class="grau"> </span><span>F#</span></div>
    <div class="key white G KeyT midi-67" data-midi="67"><span class="grau"> </span><span>G</span></div>
    <div class="key black Gs Af Digit6 midi-68" data-midi="68"><span class="grau"> </span><span>G#</span></div>
    <div class="key white A KeyY midi-69" data-midi="69"><span class="grau"> </span><span>A</span></div>
    <div class="key black As Bf Digit7 midi-70" data-midi="70"><span class="grau"> </span><span>A#</span></div>
    <div class="key white B KeyU midi-71" data-midi="71"><span class="grau"> </span><span>B</span></div> 
  
  </div> 
  <div class="keyboard k-5"> 
    <div class="key white C KeyI midi-72" data-midi="72"><span class="grau"> </span><span>C</span></div> 
    <div class="key black Cs Df Digit9 midi-73" data-midi="73"><span class="grau"> </span><span>C#</span></div>
    <div class="key white D KeyO midi-74" data-midi="74"><span class="grau"> </span><span>D</span></div>
    <div class="key black Ds Ef Digit0 midi-75" data-midi="75"><span class="grau"> </span><span>D#</span></div>
    <div class="key white E  KeyP midi-76" data-midi="76"><span class="grau"> </span><span>E</span></div>
    <div class="key white F IntlBackslash midi-77" data-midi="77"><span class="grau"> </span><span>F</span></div>
    <div class="key black Fs Gf KeyA midi-78" data-midi="78"><span class="grau"> </span><span>F#</span></div>
    <div class="key white G KeyZ midi-79" data-midi="79"><span class="grau"> </span><span>G</span></div>
    <div class="key black Gs Af KeyS midi-80" data-midi="80"><span class="grau"> </span><span>G#</span></div>
    <div class="key white A KeyX midi-81" data-midi="81"><span class="grau"> </span><span>A</span></div>
    <div class="key black As Bf KeyD midi-82" data-midi="82"><span class="grau"> </span><span>A#</span></div>
    <div class="key white B KeyC midi-83" data-midi="83"><span class="grau"> </span><span>B</span></div> 
  </div>
  <div class="keyboard k-6"> 
    <div class="key white C KeyV midi-84" data-midi="84"><span class="grau"> </span><span>C</span></div> 
    <div class="key black Cs Df KeyG midi-85" data-midi="85"><span class="grau"> </span><span>C#</span></div>
    <div class="key white D KeyB midi-86" data-midi="86"><span class="grau"> </span><span>D</span></div>
    <div class="key black Ds Ef KeyH midi-87" data-midi="87"><span class="grau"> </span><span>D#</span></div>
    <div class="key white E  KeyN midi-88" data-midi="88"><span class="grau"> </span><span>E</span></div>
    <div class="key white F KeyM midi-89" data-midi="89"><span class="grau"> </span><span>F</span></div>
    <div class="key black Fs Gf KeyK midi-90" data-midi="90"><span class="grau"> </span><span>F#</span></div>
    <div class="key white G Comma midi-91" data-midi="91"><span class="grau"> </span><span>G</span></div>
    <div class="key black Gs Af KeyL midi-92" data-midi="92"><span class="grau"> </span><span>G#</span></div>
    <div class="key white A Period midi-93" data-midi="93"><span class="grau"> </span><span>A</span></div>
    <div class="key black As Bf Semicolon midi-94" data-midi="94"><span class="grau"> </span><span>A#</span></div>
    <div class="key white B Slash midi-95" data-midi="95"><span class="grau"> </span><span>B</span></div> 
  </div>
  <style>
    .keyboard{
      margin: 0;
    }
  </style>
</div>

</body>
</html>
