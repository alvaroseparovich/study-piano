<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MIDI Keyboard - QWERTY -> Notes</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;background:#0f172a;color:#e6eef8}
    .card{background:#0b1220;padding:16px;border-radius:12px;max-width:820px}
    label,select,button{font-size:14px}
    .row{display:flex;gap:12px;align-items:center;margin:8px 0}
    .kbd{display:inline-block;padding:6px 10px;border-radius:6px;background:#0b1220;border:1px solid #223;min-width:26px;text-align:center}
    .help{opacity:.8;font-size:13px;margin-top:8px}
  </style>
  <link rel="stylesheet" href="style.css"></style>
</head>
<body>
  <div class="card">
    <h6>MIDI keyboard (Q..P + numbers) — WebMIDI + fallback synth</h6>
    <div class="row">
      <button id="enableMidi">Enable MIDI</button>
      <label for="outputs">MIDI Output:</label>
      <select id="outputs"><option value="none">(no output selected)</option></select>
      <label for="channel">Ch</label>
      <input id="channel" type="number" min="1" max="16" value="1" style="width:56px" />
    </div>
    <div class="row">
      <label><input type="checkbox" id="useSynth" checked/> Use built-in synth if no MIDI</label>
      <label style="margin-left:12px">Volume</label>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6" />
    </div>

    <div class="help">Keys mapping: Q W E R T Y U I O P  → C4..E5. Numbers 2 3 5 6 7 9 0 → black keys. Hold a key to sustain; release to stop.</div>
    <hr />
    <!-- <div>
      <strong>Key map (visual):</strong>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
        <span class="kbd">Q</span>=C4 <span class="kbd">2</span>=C#4 •
        <span class="kbd">W</span>=D4 <span class="kbd">3</span>=D#4 •
        <span class="kbd">E</span>=E4 •
        <span class="kbd">R</span>=F4 <span class="kbd">5</span>=F#4 •
        <span class="kbd">T</span>=G4 <span class="kbd">6</span>=G#4 •
        <span class="kbd">Y</span>=A4 <span class="kbd">7</span>=A#4 •
        <span class="kbd">U</span>=B4 •
        <span class="kbd">I</span>=C5 <span class="kbd">9</span>=C#5 •
        <span class="kbd">O</span>=D5 <span class="kbd">0</span>=D#5 •
        <span class="kbd">P</span>=E5
      </div>
    </div> -->
  </div>

<script>
// Key -> MIDI note number mapping
const KEY_NOTE = {
  'Q': 60, // C4
  '2': 61, // C#4
  'W': 62, // D4
  '3': 63, // D#4
  'E': 64, // E4
  'R': 65, // F4
  '5': 66, // F#4
  'T': 67, // G4
  '6': 68, // G#4
  'Y': 69, // A4
  '7': 70, // A#4
  'U': 71, // B4
  'I': 72, // C5
  '9': 73, // C#5
  'O': 74, // D5
  '0': 75, // D#5
  'P': 76  // E5
};

let midiAccess = null;
let midiOutputs = new Map();
let selectedOutputId = null;
const outputsSelect = document.getElementById('outputs');
const enableBtn = document.getElementById('enableMidi');
const channelInput = document.getElementById('channel');
const useSynthCheckbox = document.getElementById('useSynth');
const volumeControl = document.getElementById('volume');

// WebAudio fallback synth
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const activeOsc = new Map();
const synthGain = audioCtx.createGain();
synthGain.gain.value = parseFloat(volumeControl.value);
synthGain.connect(audioCtx.destination);
volumeControl.addEventListener('input', ()=> synthGain.gain.value = parseFloat(volumeControl.value));

function midiNoteToFreq(note){
  return 440 * Math.pow(2, (note - 69)/12);
}

function startSynth(note){
  if (activeOsc.has(note)) return;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = 'sawtooth';
  osc.frequency.value = midiNoteToFreq(note);
  g.gain.setValueAtTime(0, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(0.7, audioCtx.currentTime + 0.01);
  g.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.2);
  osc.connect(g); g.connect(synthGain);
  osc.start();
  activeOsc.set(note, {osc,g});
}

function stopSynth(note){
  const node = activeOsc.get(note);
  if (!node) return;
  const {osc,g} = node;
  g.gain.cancelScheduledValues(audioCtx.currentTime);
  g.gain.setValueAtTime(g.gain.value, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2);
  setTimeout(()=>{
    try{ osc.stop(); }catch(e){}
    osc.disconnect(); g.disconnect();
  }, 300);
  activeOsc.delete(note);
}

function noteOnMIDI(note, velocity=0x7f){
  if (!midiAccess || !selectedOutputId) return;
  const out = midiOutputs.get(selectedOutputId);
  if (!out) return;
  const channel = Math.max(1, Math.min(16, parseInt(channelInput.value || '1')))-1;
  const status = 0x90 | channel;
  out.send([status, note & 0x7f, velocity & 0x7f]);
}
function noteOffMIDI(note){
  if (!midiAccess || !selectedOutputId) return;
  const out = midiOutputs.get(selectedOutputId);
  if (!out) return;
  const channel = Math.max(1, Math.min(16, parseInt(channelInput.value || '1')))-1;
  const status = 0x80 | channel;
  out.send([status, note & 0x7f, 0x40]);
}

async function enableMIDI(){
  try{
    midiAccess = await navigator.requestMIDIAccess();
    midiAccess.onstatechange = refreshOutputs;
    refreshOutputs();
    enableBtn.textContent = 'MIDI enabled';
    enableBtn.disabled = true;
  }catch(err){
    console.warn('MIDI access failed', err);
    enableBtn.textContent = 'MIDI unavailable';
    enableBtn.disabled = true;
  }
}

function refreshOutputs(){
  midiOutputs.clear();
  outputsSelect.innerHTML = '';
  const noneOpt = document.createElement('option'); noneOpt.value='none'; noneOpt.textContent='(no output selected)';
  outputsSelect.appendChild(noneOpt);
  if (!midiAccess) return;
  for (const output of midiAccess.outputs.values()){
    midiOutputs.set(output.id, output);
    const opt = document.createElement('option');
    opt.value = output.id;
    opt.textContent = `${output.name} — ${output.manufacturer}`;
    outputsSelect.appendChild(opt);
  }
}

outputsSelect.addEventListener('change', ()=>{
  selectedOutputId = outputsSelect.value === 'none' ? null : outputsSelect.value;
});

enableBtn.addEventListener('click', async ()=>{
  await enableMIDI();
});

// keyboard handling: track pressed keys to avoid repeats
const pressed = new Set();
// Modify keydown and keyup to add/remove visual feedback
window.addEventListener('keydown', (ev)=>{
const k = ev.key.toUpperCase();
if (!KEY_NOTE.hasOwnProperty(k)) return;
if (pressed.has(k)) return; // held
pressed.add(k);
const note = KEY_NOTE[k];
  // ensure audio context resumed
if (audioCtx.state === 'suspended') audioCtx.resume();
if (midiAccess && selectedOutputId){
noteOnMIDI(note, 0x7f);
}else if (useSynthCheckbox.checked){
startSynth(note);
}
document.querySelector(`.qwert-${ev.key.toLowerCase()}`)?.classList.add('key-down');
ev.preventDefault();
});

window.addEventListener('keyup', (ev)=>{
const k = ev.key.toUpperCase();
if (!KEY_NOTE.hasOwnProperty(k)) return;
pressed.delete(k);
const note = KEY_NOTE[k];
if (midiAccess && selectedOutputId){
noteOffMIDI(note);
}else if (useSynthCheckbox.checked){
stopSynth(note);
}
document.querySelector(`.qwert-${ev.key.toLowerCase()}`)?.classList.remove('key-down');
ev.preventDefault();
});

// also handle visibility change: stop all on blur
window.addEventListener('blur', ()=>{
  for (const k of Array.from(pressed)){
    const note = KEY_NOTE[k];
    if (midiAccess && selectedOutputId) noteOffMIDI(note);
    else if (useSynthCheckbox.checked) stopSynth(note);
  }
  pressed.clear();
});

// Helpful: allow clicking on onscreen keys to test
// (simple implementation)
</script>




<div class="octave-midle scales-butons" style="display:flex"> 

  <div class="keyboard k-4"> 
    <div class="key white C key-note-C qwert-q"><span>C</span></div> 
    <div class="key black Cs Df key-note-Cs qwert-2"><span>C#</span></div>
    <div class="key white D key-note-D qwert-w"><span>D</span></div>
    <div class="key black Ds Ef key-note-Ds qwert-3"><span>D#</span></div>
    <div class="key white E  key-note-E qwert-e"><span>E</span></div>
    <div class="key white F key-note-F qwert-r"><span>F</span></div>
    <div class="key black Fs Gf key-note-Fs qwert-5"><span>F#</span></div>
    <div class="key white G key-note-G qwert-t"><span>G</span></div>
    <div class="key black Gs Af key-note-Gs qwert-6"><span>G#</span></div>
    <div class="key white A key-note-A qwert-y"><span>A</span></div>
    <div class="key black As Bf key-note-As qwert-7"><span>A#</span></div>
    <div class="key white B key-note-B qwert-u"><span>B</span></div> 
  
  </div> 
  <div class="keyboard k-5"> 
    <div class="key white C key-note-C qwert-i"><span>C</span></div> 
    <div class="key black Cs Df key-note-Cs qwert-9"><span>C#</span></div>
    <div class="key white D key-note-D qwert-o"><span>D</span></div>
    <div class="key black Ds Ef key-note-Ds qwert-0"><span>D#</span></div>
    <div class="key white E  key-note-E qwert-p"><span>E</span></div>
    <div class="key white F key-note-F"><span>F</span></div>
    <div class="key black Fs Gf key-note-Fs"><span>F#</span></div>
    <div class="key white G key-note-G"><span>G</span></div>
    <div class="key black Gs Af key-note-Gs"><span>G#</span></div>
    <div class="key white A key-note-A"><span>A</span></div>
    <div class="key black As Bf key-note-As"><span>A#</span></div>
    <div class="key white B key-note-B"><span>B</span></div> 
  </div>
  <style>
    .keyboard{
      margin: 0;
    }
  </style>
</div>

</body>
</html>
